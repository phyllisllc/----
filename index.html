<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>幸运抽奖</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#EC4899',
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-blue-50 to-purple-50">
  <!-- 头部区域 -->
  <header class="relative py-6 px-4 text-center">
    <div class="absolute top-4 right-4">
      <button id="show-prizes" class="bg-white/80 backdrop-blur-sm text-primary py-2 px-4 rounded-full font-medium shadow-md hover:bg-white transition-all">
        我的奖品
      </button>
    </div>
    <h1 class="text-[clamp(1.8rem,5vw,3rem)] font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">幸运抽奖</h1>
    <p class="text-gray-600 mt-2">试试手气，赢取惊喜奖品！</p>
  </header>
  
  <!-- 主要内容区域 -->
  <main class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
      <!-- 抽奖区域 -->
      <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl overflow-hidden">
        <div class="p-6">
          <div class="text-center mb-6">
            <h2 class="text-xl font-bold text-gray-800">点击开始抽奖</h2>
            <p class="text-gray-500 mt-1">每人仅有一次抽奖机会</p>
          </div>
          
          <div class="grid grid-cols-4 gap-4 mb-6">
            <!-- 奖品1: 宇树Go2 Air机器狗 -->
            <div id="prize-1" class="prize-item bg-white/90 rounded-lg p-3 flex flex-col items-center justify-center aspect-square">
              <div class="text-primary text-xs font-bold mb-1 truncate w-full text-center">宇树Go2 Air机器狗</div>
              <div class="text-primary"><i class="fa fa-trophy text-xl"></i></div>
            </div>
            
            <!-- 奖品2: 德龙咖啡机S3 Plus -->
            <div id="prize-2" class="prize-item bg-white/90 rounded-lg p-3 flex flex-col items-center justify-center aspect-square">
              <div class="text-primary text-xs font-bold mb-1 truncate w-full text-center">德龙咖啡机S3 Plus</div>
              <div class="text-primary"><i class="fa fa-gift text-xl"></i></div>
            </div>
            
            <!-- 奖品3: 美的商用微波炉EM925F4T-SS -->
            <div id="prize-3" class="prize-item bg-white/90 rounded-lg p-3 flex flex-col items-center justify-center aspect-square">
              <div class="text-primary text-xs font-bold mb-1 truncate w-full text-center">美的商用微波炉</div>
              <div class="text-primary"><i class="fa fa-star text-xl"></i></div>
            </div>
            
            <!-- 奖品4: 茶杯消毒柜28D-2 -->
            <div id="prize-4" class="prize-item bg-white/90 rounded-lg p-3 flex flex-col items-center justify-center aspect-square">
              <div class="text-primary text-xs font-bold mb-1 truncate w-full text-center">茶杯消毒柜</div>
              <div class="text-primary"><i class="fa fa-certificate text-xl"></i></div>
            </div>
            
            <!-- 奖品5: 3000-200元优惠券 -->
            <div id="prize-5" class="prize-item bg-white/90 rounded-lg p-3 flex flex-col items-center justify-center aspect-square">
              <div class="text-primary text-xs font-bold mb-1 truncate w-full text-center">3000-200元优惠券</div>
              <div class="text-primary"><i class="fa fa-ticket text-xl"></i></div>
            </div>
            
            <!-- 奖品6: 1000-50元优惠券 -->
            <div id="prize-6" class="prize-item bg-white/90 rounded-lg p-3 flex flex-col items-center justify-center aspect-square">
              <div class="text-primary text-xs font-bold mb-1 truncate w-full text-center">1000-50元优惠券</div>
              <div class="text-primary"><i class="fa fa-gift text-xl"></i></div>
            </div>
            
            <!-- 奖品7: 300-20元优惠券 -->
            <div id="prize-7" class="prize-item bg-white/90 rounded-lg p-3 flex flex-col items-center justify-center aspect-square">
              <div class="text-primary text-xs font-bold mb-1 truncate w-full text-center">300-20元优惠券</div>
              <div class="text-primary"><i class="fa fa-tag text-xl"></i></div>
            </div>
            
            <!-- 奖品8: 谢谢参与 -->
            <div id="prize-8" class="prize-item bg-white/90 rounded-lg p-3 flex flex-col items-center justify-center aspect-square">
              <div class="text-gray-400 text-sm font-bold mb-1">谢谢参与</div>
              <div class="text-gray-400"><i class="fa fa-smile-o text-lg"></i></div>
            </div>
          </div>
          
          <div class="text-center">
            <button id="draw-btn" class="bg-gradient-to-r from-primary to-secondary text-white py-4 px-12 rounded-full text-xl font-bold shadow-lg hover:opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
              开始抽奖
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- 电话号码输入弹窗 -->
  <div id="phone-modal" class="fixed inset-0 bg-black/50 z-50 items-center justify-center hidden">
    <div class="bg-white rounded-xl w-4/5 max-w-sm overflow-hidden transform transition-all duration-300 scale-100">
      <div class="bg-gradient-to-r from-primary to-secondary p-4 text-center">
        <h3 class="text-white text-xl font-bold">验证身份</h3>
      </div>
      <div class="p-6">
        <div class="mb-4">
          <label for="phone-input" class="block text-gray-700 mb-2">请输入手机号码</label>
          <input 
            type="tel" 
            id="phone-input" 
            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-gray-800"
            placeholder="请输入11位手机号码"
            maxlength="11"
          >
          <div id="phone-error" class="text-red-500 text-sm mt-1 hidden">请输入正确的手机号码</div>
          <div id="already-participated-error" class="text-red-500 text-sm mt-1 hidden">该号码已参与过抽奖</div>
        </div>
        <button id="submit-phone" class="bg-primary text-white py-3 px-8 rounded-full font-bold w-full shadow-lg hover:bg-opacity-90 transition-all">
          确定
        </button>
        <button id="cancel-phone" class="mt-3 w-full py-3 text-gray-600 font-medium">
          取消
        </button>
      </div>
    </div>
  </div>
  
  <!-- 抽奖结果弹窗 -->
  <div id="result-modal" class="fixed inset-0 bg-black/50 z-50 items-center justify-center hidden">
    <div class="bg-white rounded-xl w-4/5 max-w-sm overflow-hidden transform transition-all duration-300 scale-100">
      <div class="bg-gradient-to-r from-primary to-secondary p-4 text-center">
        <h3 class="text-white text-xl font-bold">恭喜中奖</h3>
      </div>
      <div class="p-6">
        <div id="result-prize" class="text-center py-6">
          <!-- 中奖信息将在这里动态显示 -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- 我的奖品弹窗 -->
  <div id="prizes-modal" class="fixed inset-0 bg-black/50 z-50 items-center justify-center hidden">
    <div class="bg-white rounded-xl w-4/5 max-w-sm overflow-hidden transform transition-all duration-300 scale-100">
      <div class="bg-gradient-to-r from-primary to-secondary p-4 text-center">
        <h3 class="text-white text-xl font-bold">我的奖品</h3>
      </div>
      <div class="p-6 max-h-[60vh] overflow-y-auto">
        <div id="prizes-list" class="space-y-4">
          <!-- 奖品列表将在这里动态生成 -->
        </div>
        <div id="no-prizes" class="text-center text-gray-500 py-8 hidden">
          <i class="fa fa-trophy text-gray-300 text-3xl mb-2"></i>
          <p>暂无中奖记录</p>
        </div>
      </div>
      <div class="px-6 pb-6">
        <button id="close-prizes" class="bg-gray-200 text-gray-700 py-3 px-8 rounded-full font-bold w-full hover:bg-gray-300 transition-all">
          关闭
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // 全局变量
    let currentPhone = localStorage.getItem('currentPhone');
    let isDrawing = false;
    
    // DOM元素
    const drawBtn = document.getElementById('draw-btn');
    const phoneModal = document.getElementById('phone-modal');
    const phoneInput = document.getElementById('phone-input');
    const phoneError = document.getElementById('phone-error');
    const alreadyParticipatedError = document.getElementById('already-participated-error');
    const submitPhone = document.getElementById('submit-phone');
    const cancelPhone = document.getElementById('cancel-phone');
    const resultModal = document.getElementById('result-modal');
    const resultPrize = document.getElementById('result-prize');
    const prizesModal = document.getElementById('prizes-modal');
    const prizesList = document.getElementById('prizes-list');
    const noPrizes = document.getElementById('no-prizes');
    const closePrizes = document.getElementById('close-prizes');
    const showPrizesBtn = document.getElementById('show-prizes');
    
    // 奖品配置
    const prizes = [
      { id: 1, name: '宇树Go2 Air机器狗', probability: 0, icon: 'fa-trophy' },
      { id: 2, name: '德龙咖啡机S3 Plus', probability: 0, icon: 'fa-gift' },
      { id: 3, name: '美的商用微波炉EM925F4T-SS', probability: 0.001, icon: 'fa-star' },
      { id: 4, name: '茶杯消毒柜28D-2', probability: 0.01, icon: 'fa-certificate' },
      { id: 5, name: '3000-200元优惠券', probability: 0.039, icon: 'fa-ticket' },
      { id: 6, name: '1000-50元优惠券', probability: 0.35, icon: 'fa-gift' },
      { id: 7, name: '300-20元优惠券', probability: 0.6, icon: 'fa-tag' },
      { id: 8, name: '谢谢参与', probability: 0, icon: 'fa-smile-o' }
    ];
    
    // 奖品详情
    const prizeDetails = {
      1: { description: '宇树Go2 Air机器狗', value: '¥9997' },
      2: { description: '德龙咖啡机S3 Plus', value: '¥3390' },
      3: { description: '美的商用微波炉EM925F4T-SS', value: '¥1799' },
      4: { description: '茶杯消毒柜28D-2', value: '¥549' },
      5: { description: '3000-200元优惠券', value: '¥200' },
      6: { description: '1000-50元优惠券', value: '¥50' },
      7: { description: '300-20元优惠券', value: '¥20' },
      8: { description: '谢谢参与', value: '无' }
    };
    
    // 格式化日期
    function formatDate(timestamp) {
      const date = new Date(timestamp);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }
    
    // 验证手机号
    function validatePhone(phone) {
      const phoneRegex = /^1[3-9]\d{9}$/;
      return phoneRegex.test(phone);
    }
    
    // 检查是否已参与
    function hasParticipated(phone) {
      const allUserPrizes = JSON.parse(localStorage.getItem('userPrizes') || '[]');
      return allUserPrizes.some(item => item.phone === phone);
    }
    
    // 显示电话输入弹窗
    function showPhoneModal() {
      phoneInput.value = '';
      phoneError.classList.add('hidden');
      alreadyParticipatedError.classList.add('hidden');
      phoneModal.style.display = 'flex';
    }
    
    // 隐藏电话输入弹窗
    function hidePhoneModal() {
      phoneModal.style.display = 'none';
    }
    
    // 显示抽奖结果
    function showResult(prizeId) {
      console.log('显示抽奖结果:', prizeId);
      try {
        const prize = prizes.find(p => p.id === prizeId);
        const details = prizeDetails[prizeId];
        
        if (!prize || !details) {
          console.error('未找到奖品信息:', prizeId);
          alert('显示结果时发生错误');
          return;
        }
        
        // 清空并设置结果内容
        if (resultPrize) {
          resultPrize.innerHTML = '';
          
          const iconDiv = document.createElement('div');
          iconDiv.className = 'text-6xl mb-4';
          iconDiv.innerHTML = `<i class="fa ${prize.icon} text-primary"></i>`;
          
          const nameDiv = document.createElement('div');
          nameDiv.className = 'text-xl font-bold text-gray-800 mb-2';
          nameDiv.textContent = prize.name;
          
          const descDiv = document.createElement('div');
          descDiv.className = 'text-gray-600 mb-2';
          descDiv.textContent = details.description;
          
          const valueDiv = document.createElement('div');
          valueDiv.className = 'text-gray-500 text-sm';
          valueDiv.textContent = `价值: ${details.value}`;
          
          resultPrize.appendChild(iconDiv);
          resultPrize.appendChild(nameDiv);
          resultPrize.appendChild(descDiv);
          resultPrize.appendChild(valueDiv);
        }
        
        // 显示弹窗
        if (resultModal) {
          resultModal.style.display = 'flex';
        }
        
        // 保存中奖记录
        const prizeRecord = {
          phone: currentPhone,
          prizeId: prize.id,
          prizeName: prize.name,
          prizeDescription: details.description,
          prizeValue: details.value,
          prizeIcon: prize.icon,
          timestamp: new Date().toISOString()
        };
        
        const allUserPrizes = JSON.parse(localStorage.getItem('userPrizes') || '[]');
        allUserPrizes.push(prizeRecord);
        localStorage.setItem('userPrizes', JSON.stringify(allUserPrizes));
        
        // 更新按钮状态
        if (drawBtn) {
          drawBtn.disabled = true;
          drawBtn.textContent = '已抽奖';
        }
        
      } catch (error) {
        console.error('显示结果时出错:', error);
        alert('显示结果时发生错误');
      }
    }
    
    // 隐藏抽奖结果
    function hideResult() {
      if (resultModal) {
        resultModal.style.display = 'none';
      }
    }
    
    // 显示奖品列表
    function showPrizes() {
      try {
        // 清空现有列表
        prizesList.innerHTML = '';
        
        if (!currentPhone) {
          // 如果没有电话号码，显示无记录
          noPrizes.classList.remove('hidden');
          prizesList.classList.add('hidden');
        } else {
          // 从localStorage获取所有中奖记录
          const allUserPrizes = JSON.parse(localStorage.getItem('userPrizes') || '[]');
          console.log('所有中奖记录:', allUserPrizes);
          
          // 筛选当前用户的中奖记录
          const userPrizes = allUserPrizes.filter(item => item.phone === currentPhone);
          
          if (userPrizes.length === 0) {
            // 无中奖记录
            noPrizes.classList.remove('hidden');
            prizesList.classList.add('hidden');
          } else {
            // 有中奖记录，生成列表
            noPrizes.classList.add('hidden');
            prizesList.classList.remove('hidden');
            
            // 按时间倒序排序
            userPrizes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            userPrizes.forEach((prize) => {
              const prizeItem = document.createElement('div');
              prizeItem.className = 'bg-gradient-to-r from-primary/10 to-secondary/10 rounded-lg p-4 flex items-center';
              
              // 奖品图标
              const iconDiv = document.createElement('div');
              iconDiv.className = 'bg-white rounded-full w-12 h-12 flex items-center justify-center mr-4 shadow-md';
              iconDiv.innerHTML = `<i class="fa ${prize.prizeIcon} text-primary text-xl"></i>`;
              
              // 奖品信息
              const infoDiv = document.createElement('div');
              infoDiv.className = 'flex-1';
              
              const nameSpan = document.createElement('div');
              nameSpan.className = 'font-bold text-gray-800';
              nameSpan.textContent = prize.prizeName;
              
              // 奖品价值
              const valueSpan = document.createElement('div');
              valueSpan.className = 'text-sm text-gray-500';
              valueSpan.textContent = `价值: ${prize.prizeValue || '未知'}`;
              
              // 中奖时间
              const timeSpan = document.createElement('div');
              timeSpan.className = 'text-xs text-gray-400';
              timeSpan.textContent = `中奖时间: ${formatDate(prize.timestamp)}`;
              
              infoDiv.appendChild(nameSpan);
              infoDiv.appendChild(valueSpan);
              infoDiv.appendChild(timeSpan);
              
              prizeItem.appendChild(iconDiv);
              prizeItem.appendChild(infoDiv);
              
              prizesList.appendChild(prizeItem);
            });
          }
        }
        
        // 显示弹窗
        prizesModal.style.display = 'flex';
      } catch (error) {
        console.error('显示奖品时出错:', error);
      }
    }
    
    // 隐藏奖品列表
    function hidePrizes() {
      prizesModal.style.display = 'none';
    }
    
    // 根据概率选择奖品
    function selectPrize() {
      // 检查是否是测试模式（通过URL参数判断）
      const urlParams = new URLSearchParams(window.location.search);
      const isTestMode = urlParams.has('test') || localStorage.getItem('testMode') === 'true';
      
      if (isTestMode) {
        // 测试模式下，随机选择所有奖项，包括概率为0的奖项
        return Math.floor(Math.random() * 8) + 1;
      }
      
      // 正常模式：根据概率选择奖品
      const random = Math.random();
      let cumulativeProbability = 0;
      
      // 过滤掉概率为0的奖品进行正常抽奖
      const validPrizes = prizes.filter(prize => prize.probability > 0);
      
      for (const prize of validPrizes) {
        cumulativeProbability += prize.probability;
        if (random < cumulativeProbability) {
          return prize.id;
        }
      }
      
      // 如果所有有效奖品的概率总和小于1，或者随机数超出范围，
      // 从有效奖品中随机选择一个
      if (validPrizes.length > 0) {
        const randomIndex = Math.floor(Math.random() * validPrizes.length);
        return validPrizes[randomIndex].id;
      }
      
      // 默认返回谢谢参与
      return 8;
    }
    
    // 开始抽奖动画
    function startDrawAnimation(targetPrizeId) {
      let currentStep = 0;
      const totalSteps = 30; // 减少总步数以加快动画
      let currentPrizeIndex = 0;
      let speed = 80; // 初始速度更快
      let isDecelerating = false;
      
      console.log(`开始抽奖动画，目标奖品ID: ${targetPrizeId}`);
      
      // 清除所有奖品的高亮
      function clearHighlights() {
        for (let i = 1; i <= 8; i++) {
          const prizeEl = document.getElementById(`prize-${i}`);
          if (prizeEl) {
            prizeEl.classList.remove('ring-4', 'ring-primary');
          }
        }
      }
      
      // 高亮当前奖品
      function highlightPrize(prizeId) {
        clearHighlights();
        const prizeEl = document.getElementById(`prize-${prizeId}`);
        if (prizeEl) {
          prizeEl.classList.add('ring-4', 'ring-primary');
        }
      }
      
      // 动画循环
      function animate() {
        try {
          // 安全检查
          if (currentStep > totalSteps * 1.5) { // 添加更严格的安全退出条件
            console.error('抽奖动画超时，强制结束');
            highlightPrize(targetPrizeId);
            setTimeout(() => showResult(targetPrizeId), 500);
            isDrawing = false;
            return;
          }
          
          // 更新当前奖品索引
          currentPrizeIndex = (currentPrizeIndex + 1) % 8;
          if (currentPrizeIndex === 0) currentPrizeIndex = 8; // 确保从1-8循环
          
          // 高亮当前奖品
          highlightPrize(currentPrizeIndex);
          
          // 加速阶段（前5步）
          if (currentStep < 5 && speed > 30) {
            speed -= 10;
          }
          // 匀速阶段
          else if (currentStep < totalSteps - 8) {
            speed = 30; // 匀速阶段速度更快
          }
          // 开始减速
          else if (!isDecelerating) {
            isDecelerating = true;
            // 计算剩余步数，确保在结束时正好停在目标奖品
            const remainingSteps = totalSteps - currentStep;
            const distanceToTarget = (targetPrizeId - currentPrizeIndex + 8) % 8;
            
            // 调整最后几步，确保准确停在目标奖品
            if (distanceToTarget > 0) {
              currentPrizeIndex = targetPrizeId - remainingSteps % 8;
              if (currentPrizeIndex < 1) currentPrizeIndex += 8;
            }
          }
          // 减速阶段
          else {
            speed += 15; // 增加减速步长
          }
          
          currentStep++;
          
          console.log(`动画步骤: ${currentStep}/${totalSteps}, 当前奖品: ${currentPrizeIndex}, 速度: ${speed}ms`);
          
          // 动画结束条件
          if (currentStep < totalSteps) {
            setTimeout(animate, speed);
          } else {
            // 确保最终停在目标奖品
            highlightPrize(targetPrizeId);
            console.log('抽奖动画结束，停在奖品ID:', targetPrizeId);
            
            // 显示结果
            setTimeout(() => {
              showResult(targetPrizeId);
              isDrawing = false;
            }, 500);
          }
        } catch (error) {
          console.error('抽奖动画出错:', error);
          isDrawing = false;
        }
      }
      
      // 开始动画
      animate();
    }
    
    // 开始抽奖
    function startDraw() {
      if (isDrawing) return;
      
      if (!currentPhone) {
        showPhoneModal();
        return;
      }
      
      isDrawing = true;
      drawBtn.disabled = true;
      
      // 选择奖品
      const targetPrizeId = selectPrize();
      
      // 开始动画
      startDrawAnimation(targetPrizeId);
    }
    
    // 提交电话号码
    function submitPhoneNumber() {
      const phone = phoneInput.value.trim();
      
      // 验证手机号
      if (!validatePhone(phone)) {
        phoneError.classList.remove('hidden');
        return;
      }
      
      // 检查是否已参与
      if (hasParticipated(phone)) {
        phoneError.classList.add('hidden');
        alreadyParticipatedError.classList.remove('hidden');
        return;
      }
      
      // 保存手机号
      currentPhone = phone;
      localStorage.setItem('currentPhone', phone);
      
      // 隐藏弹窗并开始抽奖
      hidePhoneModal();
      startDraw();
    }
    
    // 测试函数 - 直接显示结果
    function testShowResult() {
      console.log('测试显示结果功能');
      const testPrizeId = Math.floor(Math.random() * 8) + 1;
      showResult(testPrizeId);
    }
    
    // 测试函数 - 测试抽奖
    function testDraw() {
      console.log('测试抽奖功能');
      // 模拟未登录状态
      localStorage.removeItem('currentPhone');
      currentPhone = null;
      
      // 重置抽奖按钮
      if (drawBtn) {
        drawBtn.disabled = false;
        drawBtn.textContent = '开始抽奖';
      }
      
      // 模拟输入手机号并抽奖
      setTimeout(() => {
        phoneInput.value = '13800138000';
        setTimeout(() => {
          submitPhoneNumber();
        }, 500);
      }, 500);
    }
    
    // 事件监听器
    function initEventListeners() {
      // 抽奖按钮
      if (drawBtn) {
        drawBtn.addEventListener('click', startDraw);
      }
      
      // 提交手机号
      if (submitPhone) {
        submitPhone.addEventListener('click', submitPhoneNumber);
      }
      
      // 取消手机号输入
      if (cancelPhone) {
        cancelPhone.addEventListener('click', hidePhoneModal);
      }
      
      // 显示奖品列表
      if (showPrizesBtn) {
        showPrizesBtn.addEventListener('click', showPrizes);
      }
      
      // 关闭奖品列表
      if (closePrizes) {
        closePrizes.addEventListener('click', hidePrizes);
      }
      
      // 点击结果弹窗外部关闭
      if (resultModal) {
        resultModal.addEventListener('click', (e) => {
          if (e.target === resultModal) {
            hideResult();
          }
        });
      }
      
      // 点击奖品弹窗外部关闭
      if (prizesModal) {
        prizesModal.addEventListener('click', (e) => {
          if (e.target === prizesModal) {
            hidePrizes();
          }
        });
      }
      
      // 点击电话弹窗外部关闭
      if (phoneModal) {
        phoneModal.addEventListener('click', (e) => {
          if (e.target === phoneModal) {
            hidePhoneModal();
          }
        });
      }
      
      // 检查是否已抽奖
      if (currentPhone && hasParticipated(currentPhone)) {
        if (drawBtn) {
          drawBtn.disabled = true;
          drawBtn.textContent = '已抽奖';
        }
      }
    }
    
    // 初始化
    function init() {
      initEventListeners();
      
      // 添加测试按钮
      window.onload = function() {
        // 创建测试按钮
        const testBtn = document.createElement('button');
        testBtn.id = 'testDrawBtn';
        testBtn.textContent = '测试抽奖';
        testBtn.className = 'fixed bottom-6 right-6 bg-red-500 text-white py-2 px-4 rounded-full shadow-lg z-50';
        
        // 设置测试模式变量
        let testMode = 'draw'; // 'draw' 或 'result'
        
        // 绑定点击事件
        testBtn.onclick = function() {
          if (testMode === 'draw') {
            console.log('点击测试抽奖按钮');
            testDraw();
            // 切换到结果模式
            testMode = 'result';
            testBtn.textContent = '测试结果显示';
            testBtn.style.background = '#4CAF50';
          } else {
            console.log('点击测试结果显示按钮');
            testShowResult();
            // 切换回抽奖模式
            testMode = 'draw';
            testBtn.textContent = '测试抽奖';
            testBtn.style.background = '#ff6b6b';
          }
        };
        
        // 添加到页面
        document.body.appendChild(testBtn);
        console.log('测试按钮已添加');
      };
    }
    
    // 启动应用
    init();
  </script>
</body>
</html>